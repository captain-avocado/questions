# Области видимости. Лексическое окружение и замыкания. IIFE

## Области видимости

Область видимости – текущий контекст в коде, который определяет где в коде доступны переменные и функции.
Глобальная ОВ – ОВ высшего уровня. Локальные ОВ – любые ОВ ниже глобальной.
В большинстве си-подобных языков используется *блочная ОВ*, то есть переменные и функции доступны внутри блока, ограниченного `{}`. В JavaScript используется *функциональная ОВ*, то есть ОВ ограничена функциями.

Блочная ОВ:

```js
var i = 0;
if (i === 0) {
  var j = 0;
}

console.log(j) //в си-подобных языках переменная была бы недоступна, в js выведет 0

```

Функциональная ОВ:

```js
var i = 0;
function f() {
  var j = 0;
}

console.log(j) //ошибка: j не объявлена

```

## Лексическое окружение и замыкания

При запуске функции создается специальный внутренний объект – *лексическое окружение*: `[[Scope]]`. В него записываются все объявленные в данной функции переменные, другие функции, параметры. В каждом таком объекте также хранится ссылка на внешний объект (внешнее лексическое окружение функции, где была вызвана данная функция). Интерпретатор при доступе к переменным/функциям сначала ищет их в текущем лексическом окружении и, если не находит, обращается по данной ссылке к внешнему лексическому окружению. И так далее он поднимается по ссылкам на внешние лексические окржения, пока не найдет искомую переменную/функцию, либо пока не дойдет до лексического окружения самого высокого уровня.
Имея доступ к этим переменным внутри данной функции, их можно читать и изменять. Таким образом происходит *замыкание* функции и внешних переменных, необходимых для ее работы. 

Пример: счетчик

```js
function counter() {
  let i = 0;
  return function() {
    console.log(++i);
  }
}

var count = counter();

count(); //1
count(); //2
count(); //3
```

## IIFE

IIFE – *Immediately Invoked Function Expression*, или анонимная самовызывающаяся функция. Используется для того, чтобы не засорять глобальную область видимости, то есть чтобы переменные внутри функции не влияли на переменные из других областей видимости. Тем не менее, благодаря замыканию имеет доступ к переменным в глобальной ОВ. Так же, как и в любую другую функцию, в нее возможно передать параметры.

Почему function expression:

```js
(function(){})();

var f = function(){};
f();
```

Пример:

```js

var c = 30;
var d = 40;

(function(d){
  //эти переменные недоступны в глобальной области видимости
  var a = 10;
  var b = 20;

  //вывод в глобальную область видимости
  window.b = b;

  //доступна из-за замыкания
  c = 50;

  //доступна как параметр
  d = 60;

})(d);

console.log(a); //reference error: a is not defined
console.log(b); //20
console.log(c); //50 - изменилась в замыкании
console.log(d); //40 - не изменилась, тк это был параметр
```




